# 테스트 스위트 계획

> 작성일: 2024-12-09  
> 버전: 1.0  
> 관련 문서: 레이아웃_리팩토링_계획.md

---

## 1. 현재 테스트 구조

### 1.1 Unit Tests (Vitest)

```
tests/
├── customFurniture.test.ts    # 커스텀 가구
├── door.test.ts               # 문 유틸리티
├── floorPlanImage.test.ts     # 이미지 처리
├── floorPlanStorage.test.ts   # 저장/불러오기
├── FurnitureLibrary.test.ts   # 가구 라이브러리 컴포넌트
├── history.test.ts            # Undo/Redo
├── layerOrder.test.ts         # 레이어 정렬
├── measureTool.test.ts        # 측정 도구
├── objectEdit.test.ts         # 객체 편집
├── ObjectEditPopup.test.ts    # 편집 팝업 컴포넌트
└── wall.test.ts               # 벽체 유틸리티
```

**총 11개 파일**

### 1.2 E2E Tests (Playwright)

```
e2e/
├── customFurniture.spec.ts    # 커스텀 가구 생성
├── floorPlanImage.spec.ts     # 이미지 업로드/조작
├── layerOrder.spec.ts         # 레이어 순서 변경
├── measureTool.spec.ts        # 측정 도구
├── objectEdit.spec.ts         # 객체 편집
└── wall.spec.ts               # 벽체 생성/편집
```

**총 6개 파일**

---

## 2. 리팩토링 영향 분석

### 2.1 Unit Tests - 영향도

| 테스트 파일 | 대상 | 영향 | 조치 |
|------------|------|------|------|
| wall.test.ts | utils/wall.ts | ✅ 없음 | 유지 |
| door.test.ts | utils/door.ts | ✅ 없음 | 유지 |
| layerOrder.test.ts | utils/layerOrder.ts | ✅ 없음 | 유지 |
| measureTool.test.ts | utils/measureTool.ts | ✅ 없음 | 유지 |
| objectEdit.test.ts | utils/objectEdit.ts | ✅ 없음 | 유지 |
| floorPlanStorage.test.ts | utils/floorPlanStorage.ts | ✅ 없음 | 유지 |
| floorPlanImage.test.ts | utils/floorPlanImage.ts | ✅ 없음 | 유지 |
| customFurniture.test.ts | utils/customFurniture.ts | ✅ 없음 | 유지 |
| history.test.ts | composables/useHistory.ts | ⚠️ Store 이동 | 경로 수정 |
| FurnitureLibrary.test.ts | 컴포넌트 | ⚠️ 경로 변경 | import 수정 |
| ObjectEditPopup.test.ts | 컴포넌트 | ⚠️ 경로 변경 | import 수정 |

**결론**: 11개 중 **8개 유지**, **3개 수정** 필요

### 2.2 E2E Tests - 영향도

| 테스트 파일 | 주요 셀렉터 | 영향 | 조치 |
|------------|------------|------|------|
| wall.spec.ts | `.konvajs-content`, 키보드 | ⚠️ 낮음 | 일부 수정 |
| objectEdit.spec.ts | 텍스트 기반 | ⚠️ 낮음 | 일부 수정 |
| measureTool.spec.ts | 키보드, 캔버스 | ⚠️ 낮음 | 일부 수정 |
| layerOrder.spec.ts | 레이어 패널 | ⚠️ 중간 | 셀렉터 수정 |
| floorPlanImage.spec.ts | 버튼, 파일 | ⚠️ 중간 | 셀렉터 수정 |
| customFurniture.spec.ts | 모달, 폼 | ⚠️ 중간 | 셀렉터 수정 |

**결론**: 6개 모두 **셀렉터 일부 수정** 필요

---

## 3. 테스트 마이그레이션 전략

### 3.1 사전 작업: data-testid 추가

리팩토링 전에 주요 요소에 `data-testid` 속성 추가:

```vue
<!-- 현재 -->
<div class="w-64 max-h-96">
  <!-- 레이어 패널 -->
</div>

<!-- 개선 -->
<div class="w-64 max-h-96" data-testid="layer-panel">
  <!-- 레이어 패널 -->
</div>
```

#### 추가할 data-testid 목록

| 컴포넌트 | data-testid | 용도 |
|----------|-------------|------|
| 캔버스 컨테이너 | `floor-canvas` | 캔버스 영역 선택 |
| 레이어 패널 | `layer-panel` | 레이어 조작 |
| 속성 패널 | `property-panel` | 속성 편집 |
| 도구바 | `toolbar` | 도구 선택 |
| 메뉴바 | `menubar` | 메뉴 접근 |
| 상태바 | `statusbar` | 줌/좌표 확인 |
| 가구 라이브러리 | `furniture-library` | 가구 드래그 |
| 방 생성 모달 | `room-modal` | 방 생성 |
| 문 추가 모달 | `door-modal` | 문 추가 |

### 3.2 셀렉터 마이그레이션

#### Before (CSS 클래스 기반)

```typescript
// e2e/layerOrder.spec.ts
const layerPanel = page.locator('.w-64.max-h-96')
const layerItem = layerPanel.locator('.flex.items-center.gap-2').first()
```

#### After (data-testid 기반)

```typescript
// e2e/layerOrder.spec.ts
const layerPanel = page.getByTestId('layer-panel')
const layerItem = layerPanel.getByTestId('layer-item').first()
```

---

## 4. 신규 테스트 추가 계획

### 4.1 Store Unit Tests

```
tests/stores/
├── useEditorStore.test.ts
├── useCanvasStore.test.ts
├── useSelectionStore.test.ts
└── useHistoryStore.test.ts
```

#### useEditorStore.test.ts

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useEditorStore } from '~/stores/useEditorStore'

describe('useEditorStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  describe('activeTool', () => {
    it('기본값은 select이다', () => {
      const store = useEditorStore()
      expect(store.activeTool).toBe('select')
    })

    it('도구를 변경할 수 있다', () => {
      const store = useEditorStore()
      store.activeTool = 'wall'
      expect(store.activeTool).toBe('wall')
    })
  })

  describe('zoom', () => {
    it('기본 줌은 1이다', () => {
      const store = useEditorStore()
      expect(store.zoom).toBe(1)
    })

    it('zoomIn은 줌을 1.2배 증가시킨다', () => {
      const store = useEditorStore()
      store.zoomIn()
      expect(store.zoom).toBeCloseTo(1.2)
    })

    it('zoomOut은 줌을 1.2배 감소시킨다', () => {
      const store = useEditorStore()
      store.zoomOut()
      expect(store.zoom).toBeCloseTo(0.833, 2)
    })

    it('줌은 0.3~3 범위로 제한된다', () => {
      const store = useEditorStore()
      store.zoom = 0.1
      store.zoomOut()
      expect(store.zoom).toBeGreaterThanOrEqual(0.3)

      store.zoom = 5
      store.zoomIn()
      expect(store.zoom).toBeLessThanOrEqual(3)
    })
  })

  describe('mode', () => {
    it('기본 모드는 normal이다', () => {
      const store = useEditorStore()
      expect(store.mode).toBe('normal')
    })

    it('measure 도구 선택 시 모드가 measure로 변경된다', () => {
      const store = useEditorStore()
      store.activeTool = 'measure'
      expect(store.mode).toBe('measure')
    })

    it('wall 도구 선택 시 모드가 draw로 변경된다', () => {
      const store = useEditorStore()
      store.activeTool = 'wall'
      expect(store.mode).toBe('draw')
    })
  })
})
```

#### useCanvasStore.test.ts

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useCanvasStore } from '~/stores/useCanvasStore'

describe('useCanvasStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  describe('rooms', () => {
    it('초기에 빈 배열이다', () => {
      const store = useCanvasStore()
      expect(store.rooms).toEqual([])
    })

    it('room computed는 첫 번째 방을 반환한다', () => {
      const store = useCanvasStore()
      const room = { id: 'room-1', x: 0, y: 0, width: 800, height: 600, opacity: 1, zIndex: 0 }
      store.rooms.push(room)
      expect(store.room).toEqual(room)
    })

    it('room이 없으면 null을 반환한다', () => {
      const store = useCanvasStore()
      expect(store.room).toBeNull()
    })
  })

  describe('furniture CRUD', () => {
    it('가구를 추가할 수 있다', () => {
      const store = useCanvasStore()
      const furniture = {
        id: 'f-1',
        name: '침대',
        x: 100,
        y: 100,
        width: 200,
        height: 180,
        color: '#8B4513',
        rotation: 0,
        zIndex: 1,
      }
      store.addFurniture(furniture)
      expect(store.furnitureList).toHaveLength(1)
      expect(store.furnitureList[0]).toEqual(furniture)
    })

    it('가구를 삭제할 수 있다', () => {
      const store = useCanvasStore()
      store.addFurniture({ id: 'f-1', name: 'test', x: 0, y: 0, width: 100, height: 100, color: '#fff', rotation: 0, zIndex: 1 })
      store.addFurniture({ id: 'f-2', name: 'test2', x: 0, y: 0, width: 100, height: 100, color: '#fff', rotation: 0, zIndex: 2 })
      
      store.removeFurniture('f-1')
      expect(store.furnitureList).toHaveLength(1)
      expect(store.furnitureList[0].id).toBe('f-2')
    })

    it('가구를 업데이트할 수 있다', () => {
      const store = useCanvasStore()
      store.addFurniture({ id: 'f-1', name: '침대', x: 0, y: 0, width: 100, height: 100, color: '#fff', rotation: 0, zIndex: 1 })
      
      store.updateFurniture('f-1', { x: 200, y: 200 })
      expect(store.furnitureList[0].x).toBe(200)
      expect(store.furnitureList[0].y).toBe(200)
      expect(store.furnitureList[0].name).toBe('침대') // 다른 속성은 유지
    })
  })

  describe('walls', () => {
    it('벽체를 추가할 수 있다', () => {
      const store = useCanvasStore()
      const wall = { id: 'w-1', startX: 0, startY: 0, endX: 100, endY: 0, thickness: 15, isExterior: false, color: '#9CA3AF', zIndex: 1 }
      store.addWall(wall)
      expect(store.wallList).toHaveLength(1)
    })
  })
})
```

#### useSelectionStore.test.ts

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useSelectionStore } from '~/stores/useSelectionStore'

describe('useSelectionStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  describe('단일 선택', () => {
    it('객체를 선택할 수 있다', () => {
      const store = useSelectionStore()
      store.select('f-1', 'furniture')
      expect(store.selectedId).toBe('f-1')
      expect(store.selectedType).toBe('furniture')
    })

    it('선택을 해제할 수 있다', () => {
      const store = useSelectionStore()
      store.select('f-1', 'furniture')
      store.clearSelection()
      expect(store.selectedId).toBeNull()
      expect(store.selectedType).toBeNull()
    })

    it('다른 객체를 선택하면 이전 선택이 해제된다', () => {
      const store = useSelectionStore()
      store.select('f-1', 'furniture')
      store.select('w-1', 'wall')
      expect(store.selectedId).toBe('w-1')
      expect(store.selectedType).toBe('wall')
    })
  })

  describe('다중 선택', () => {
    it('다중 선택을 토글할 수 있다', () => {
      const store = useSelectionStore()
      store.toggleMultiSelect('f-1')
      store.toggleMultiSelect('f-2')
      expect(store.multiSelectedIds.has('f-1')).toBe(true)
      expect(store.multiSelectedIds.has('f-2')).toBe(true)
    })

    it('이미 선택된 객체를 토글하면 선택 해제된다', () => {
      const store = useSelectionStore()
      store.toggleMultiSelect('f-1')
      store.toggleMultiSelect('f-1')
      expect(store.multiSelectedIds.has('f-1')).toBe(false)
    })

    it('isMultiSelect가 다중 선택 상태를 반환한다', () => {
      const store = useSelectionStore()
      expect(store.isMultiSelect).toBe(false)
      
      store.toggleMultiSelect('f-1')
      expect(store.isMultiSelect).toBe(false) // 1개는 multi 아님
      
      store.toggleMultiSelect('f-2')
      expect(store.isMultiSelect).toBe(true)
    })
  })

  describe('hasSelection computed', () => {
    it('선택이 없으면 false', () => {
      const store = useSelectionStore()
      expect(store.hasSelection).toBe(false)
    })

    it('단일 선택이 있으면 true', () => {
      const store = useSelectionStore()
      store.select('f-1', 'furniture')
      expect(store.hasSelection).toBe(true)
    })
  })
})
```

#### useHistoryStore.test.ts

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { setActivePinia, createPinia } from 'pinia'
import { useHistoryStore } from '~/stores/useHistoryStore'

describe('useHistoryStore', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  describe('pushState', () => {
    it('상태를 스택에 추가한다', () => {
      const store = useHistoryStore()
      const state = { rooms: [], furnitureList: [], wallList: [], doorList: [] }
      store.pushState(state)
      expect(store.canUndo).toBe(true)
    })

    it('새 상태 추가 시 redo 스택이 초기화된다', () => {
      const store = useHistoryStore()
      store.pushState({ rooms: [], furnitureList: [], wallList: [], doorList: [] })
      store.pushState({ rooms: [], furnitureList: [{ id: 'f-1' }], wallList: [], doorList: [] })
      store.undo()
      expect(store.canRedo).toBe(true)
      
      store.pushState({ rooms: [], furnitureList: [{ id: 'f-2' }], wallList: [], doorList: [] })
      expect(store.canRedo).toBe(false)
    })
  })

  describe('undo', () => {
    it('이전 상태를 반환한다', () => {
      const store = useHistoryStore()
      const state1 = { rooms: [], furnitureList: [], wallList: [], doorList: [] }
      const state2 = { rooms: [], furnitureList: [{ id: 'f-1' }], wallList: [], doorList: [] }
      store.pushState(state1)
      store.pushState(state2)
      
      const undone = store.undo()
      expect(undone).toEqual(state1)
    })

    it('스택이 비어있으면 null을 반환한다', () => {
      const store = useHistoryStore()
      expect(store.undo()).toBeNull()
    })
  })

  describe('redo', () => {
    it('undo된 상태를 복원한다', () => {
      const store = useHistoryStore()
      const state1 = { rooms: [], furnitureList: [], wallList: [], doorList: [] }
      const state2 = { rooms: [], furnitureList: [{ id: 'f-1' }], wallList: [], doorList: [] }
      store.pushState(state1)
      store.pushState(state2)
      store.undo()
      
      const redone = store.redo()
      expect(redone).toEqual(state2)
    })
  })

  describe('maxHistory', () => {
    it('최대 히스토리 개수를 초과하면 오래된 것부터 제거', () => {
      const store = useHistoryStore()
      // maxHistory = 50이라 가정
      for (let i = 0; i < 60; i++) {
        store.pushState({ rooms: [], furnitureList: [{ id: `f-${i}` }], wallList: [], doorList: [] })
      }
      
      // undo를 50번 이상 할 수 없어야 함
      let undoCount = 0
      while (store.canUndo) {
        store.undo()
        undoCount++
      }
      expect(undoCount).toBeLessThanOrEqual(50)
    })
  })
})
```

### 4.2 새 컴포넌트 Unit Tests

```
tests/components/
├── MenuBar.test.ts
├── LeftPanel.test.ts
├── RightPanel.test.ts
├── PropertyPanel.test.ts
├── StatusBar.test.ts
├── ToolButton.test.ts
└── MenuDropdown.test.ts
```

### 4.3 E2E 테스트 추가

```
e2e/
├── layout.spec.ts           # 신규: 레이아웃 테스트
├── menubar.spec.ts          # 신규: 메뉴바 테스트
└── keyboard-shortcuts.spec.ts # 신규: 단축키 테스트
```

#### layout.spec.ts

```typescript
import { test, expect } from '@playwright/test'

test.describe('레이아웃', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/')
  })

  test('3-Column 레이아웃이 표시된다', async ({ page }) => {
    await expect(page.getByTestId('toolbar')).toBeVisible()
    await expect(page.getByTestId('floor-canvas')).toBeVisible()
    await expect(page.getByTestId('property-panel')).toBeVisible()
    await expect(page.getByTestId('layer-panel')).toBeVisible()
  })

  test('메뉴바가 상단에 표시된다', async ({ page }) => {
    await expect(page.getByTestId('menubar')).toBeVisible()
    await expect(page.getByText('파일')).toBeVisible()
    await expect(page.getByText('편집')).toBeVisible()
    await expect(page.getByText('보기')).toBeVisible()
  })

  test('상태바가 하단에 표시된다', async ({ page }) => {
    await expect(page.getByTestId('statusbar')).toBeVisible()
    await expect(page.getByText('100%')).toBeVisible() // 기본 줌
  })

  test('도구 버튼을 클릭하면 활성화된다', async ({ page }) => {
    const wallTool = page.getByTestId('tool-wall')
    await wallTool.click()
    await expect(wallTool).toHaveAttribute('data-active', 'true')
  })
})
```

---

## 5. 테스트 커버리지 목표

### 5.1 Unit Test 커버리지

| 영역 | 현재 | 목표 |
|------|------|------|
| utils/ | ~80% | 80% (유지) |
| stores/ | 0% | 80% |
| composables/ | ~70% | 80% |
| components/ | ~30% | 50% |

### 5.2 E2E 시나리오 커버리지

| 기능 | 현재 | 목표 |
|------|------|------|
| 벽체 생성/편집 | ✅ | ✅ |
| 가구 배치/편집 | ✅ | ✅ |
| 레이어 순서 | ✅ | ✅ |
| 측정 도구 | ✅ | ✅ |
| 이미지 업로드 | ✅ | ✅ |
| 커스텀 가구 | ✅ | ✅ |
| 메뉴바 동작 | ❌ | ✅ |
| 단축키 | ❌ | ✅ |
| 레이아웃 반응형 | ❌ | ✅ |

---

## 6. 마이그레이션 체크리스트

### 6.1 리팩토링 전

- [ ] 현재 모든 테스트 통과 확인 (`npm test`, `npm run test:e2e`)
- [ ] 테스트 결과 스냅샷 저장
- [ ] data-testid 추가 (주요 컴포넌트)
- [ ] E2E 베이스라인 스크린샷 저장

### 6.2 리팩토링 중

- [ ] Phase별 테스트 실행
- [ ] 실패한 테스트 즉시 수정
- [ ] 새 Store 테스트 작성

### 6.3 리팩토링 후

- [ ] 전체 Unit Test 통과
- [ ] 전체 E2E Test 통과
- [ ] 커버리지 리포트 생성
- [ ] 신규 테스트 추가

---

## 7. 테스트 실행 명령어

```bash
# Unit Tests
npm test                    # 전체 실행
npm test -- --watch         # Watch 모드
npm test -- wall.test.ts    # 특정 파일
npm test -- --coverage      # 커버리지 리포트

# E2E Tests
npm run test:e2e            # 전체 실행
npm run test:e2e -- --ui    # UI 모드
npm run test:e2e wall.spec.ts  # 특정 파일
npm run test:e2e -- --debug    # 디버그 모드

# 전체 테스트
npm run test:all            # Unit + E2E
```

---

## 8. CI/CD 통합

### 8.1 GitHub Actions 워크플로우

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm test -- --coverage
      - uses: codecov/codecov-action@v3

  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run test:e2e
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
```

---

## 9. 예상 일정

| 작업 | 예상 시간 |
|------|----------|
| data-testid 추가 | 1h |
| Store 테스트 작성 (4개) | 3h |
| 컴포넌트 테스트 경로 수정 | 0.5h |
| E2E 셀렉터 업데이트 | 1.5h |
| 신규 E2E 테스트 작성 | 2h |
| CI/CD 설정 | 1h |
| **총계** | **~9h** |

---

## 부록: 테스트 유틸리티

### A.1 Pinia 테스트 헬퍼

```typescript
// tests/helpers/pinia.ts
import { createPinia, setActivePinia } from 'pinia'

export function setupPinia() {
  const pinia = createPinia()
  setActivePinia(pinia)
  return pinia
}
```

### A.2 Playwright 커스텀 매처

```typescript
// e2e/fixtures.ts
import { test as base, expect } from '@playwright/test'

export const test = base.extend({
  // 캔버스 헬퍼
  canvas: async ({ page }, use) => {
    const canvas = page.locator('[data-testid="floor-canvas"]')
    await use(canvas)
  },
})

export { expect }
```

### A.3 테스트 데이터 팩토리

```typescript
// tests/factories/furniture.ts
import type { Furniture } from '~/types/furniture'

let idCounter = 0

export function createFurniture(overrides: Partial<Furniture> = {}): Furniture {
  return {
    id: `furniture-${++idCounter}`,
    name: '테스트 가구',
    x: 0,
    y: 0,
    width: 100,
    height: 100,
    color: '#8B4513',
    rotation: 0,
    zIndex: 1,
    ...overrides,
  }
}

export function createWall(overrides = {}) {
  return {
    id: `wall-${++idCounter}`,
    startX: 0,
    startY: 0,
    endX: 100,
    endY: 0,
    thickness: 15,
    isExterior: false,
    color: '#9CA3AF',
    zIndex: 1,
    ...overrides,
  }
}
```
